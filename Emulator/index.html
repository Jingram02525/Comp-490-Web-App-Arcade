<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBA Emulator | RePlay</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&family=Press+Start+2P&display=swap"
          rel="stylesheet">
    <script src="js/util.js"></script>
    <script src="js/core.js"></script>
    <script src="js/arm.js"></script>
    <script src="js/thumb.js"></script>
    <script src="js/mmu.js"></script>
    <script src="js/io.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/video.js"></script>
    <script src="js/video/proxy.js"></script>
    <script src="js/video/software.js"></script>
    <script src="js/irq.js"></script>
    <script src="js/keypad.js"></script>
    <script src="js/sio.js"></script>
    <script src="js/savedata.js"></script>
    <script src="js/gpio.js"></script>
    <script src="js/gba.js"></script>
    <script src="resources/xhr.js"></script>
    <script>
        var gba;
        var runCommands = [];
        var debug = null;

        function initializeGBA() {
            try {
                gba = new GameBoyAdvance();
                gba.keypad.eatInput = true;
                gba.setLogger(function (level, error) {
                    console.log(error);
                    gba.pause();
                    var screen = document.getElementById('screen');
                    if (screen.classList.contains('dead')) {
                        console.log('We appear to have crashed multiple times without resetting.');
                        return;
                    }
                    var crash = document.createElement('img');
                    crash.setAttribute('id', 'crash');
                    crash.setAttribute('src', 'resources/crash.png');
                    screen.parentElement.insertBefore(crash, screen);
                    screen.classList.add('dead');
                });
            } catch (exception) {
                gba = null;
                console.error('Failed to initialize GBA emulator:', exception);
            }

            if (gba && FileReader) {
                var canvas = document.getElementById('screen');
                gba.setCanvas(canvas);

                loadRom('resources/bios.bin', function (bios) {
                    gba.setBios(bios);
                });

                if (!gba.audio.context) {
                    var soundbox = document.getElementById('sound');
                    soundbox.parentElement.removeChild(soundbox);
                }

                if (window.navigator.appName === 'Microsoft Internet Explorer') {
                    var pixelatedBox = document.getElementById('pixelated');
                    pixelatedBox.parentElement.removeChild(pixelatedBox);
                }
            } else {
                var dead = document.getElementById('controls');
                dead.parentElement.removeChild(dead);
            }
        }

        function run(file) {
            var dead = document.getElementById('loader');
            dead.value = '';
            var load = document.getElementById('select');
            load.textContent = 'Loading...';
            load.removeAttribute('onclick');
            var pause = document.getElementById('pause');
            pause.textContent = "PAUSE";
            gba.loadRomFromFile(file, function (result) {
                if (result) {
                    for (var i = 0; i < runCommands.length; ++i) {
                        runCommands[i]();
                    }
                    runCommands = [];
                    fadeOut('preload', 'ingame');
                    document.getElementById('placeholder').style.display = 'none';
                    document.getElementById('screen').style.display = 'block';
                    gba.runStable();
                } else {
                    load.textContent = 'FAILED';
                    setTimeout(function () {
                        load.textContent = 'SELECT';
                        load.onclick = function () {
                            document.getElementById('loader').click();
                        };
                    }, 3000);
                }
            });
        }

        function fadeOut(id, nextId) {
            var e = document.getElementById(id);
            var e2 = document.getElementById(nextId);
            if (!e) {
                return;
            }
            e.classList.add('hidden');
            if (e2) {
                e2.classList.remove('hidden');
            }
        }

        window.onload = initializeGBA;
    </script>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">RePlay</a>
        <div class="search-bar">
            <input type="text" placeholder="ROMs, Games, etc,...">
            <button type="submit">Search</button>
        </div>
        <ul class="navbar-links">
            <li><a href="roms.html" class="roms">ROMS</a></li>
            <li><a href="emulator.html" class="emu">Emulators</a></li>
            <li><a href="login.html" class="login">Login</a></li>
            <li><a href="register.html" class="signup">Sign Up</a></li>
        </ul>
    </nav>
    <main>
        <div class="emulator-container">
            <!-- Placeholder Image -->
            <img id="placeholder" src="resources/gba-placeholder.png" alt="GameBoy Advance Emulator Placeholder" class="placeholder">

            <!-- GBA Emulator Screen -->
            <canvas id="screen" width="480" height="320" style="display: none;"></canvas>

            <section id="controls">
                <div id="preload">
                    <button class="bigbutton" id="select" onclick="document.getElementById('loader').click()">SELECT</button>
                    <input id="loader" type="file" accept=".gba" onchange="run(this.files[0]);">
                </div>
                <div id="ingame" class="hidden">
                    <button id="pause" class="bigbutton" onclick="togglePause()">PAUSE</button>
                    <button class="bigbutton" onclick="reset()">RESET</button>
                    <button onclick="gba.downloadSavedata()">Download Savegame</button>
                    <div id="sound">
                        <input type="checkbox" checked onchange="gba.audio.masterEnable = this.checked">
                        <p>Sound</p>
                        <input type="range" min="0" max="1" value="1" step="any" onchange="setVolume(this.value)" oninput="setVolume(this.value)">
                    </div>
                </div>
            </section>
        </div>
    </main>
    <footer>
        <p>&copy; 2024 RePlay | <a href="terms.html">Terms and Conditions</a> | <a href="privacy.html">Privacy Policy</a></p>
    </footer>
</body>
</html>
